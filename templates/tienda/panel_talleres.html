{% extends 'general.html' %}
{% block title %}Gesti√≥n de Talleres{% endblock %}

{% block content %}
<section class="panel-right">
  <h2><i class="fa fa-paint-brush"></i> Gesti√≥n de Talleres</h2>
  <p>Desde aqu√≠ puedes crear, editar o eliminar talleres programados.</p>

  <!-- MENSAJES DE ERROR/√âXITO -->
  {% if messages %}
    <div class="message-container">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- FORMULARIO ORDENADO CON VALIDACIONES -->
  <form method="POST" enctype="multipart/form-data" class="form-talleres" id="form-taller">
    {% csrf_token %}
    <input type="hidden" name="id" id="taller_id">
    <input type="hidden" name="accion" id="accion" value="crear">

    <div class="form-grid-2">

      <div class="form-block">
        <label for="taller_base">Taller Existente: <span style="color: red;">*</span></label>
        <select name="taller_base" id="taller_base">
          <option value="">-- Seleccionar --</option>
          {% for base in talleres_base %}
          <option value="{{ base.id }}">{{ base.titulo }}</option>
          {% endfor %}
        </select>

        <label>O crea uno nuevo:</label>
        <input type="text" name="nuevo_taller_base" id="nuevo_taller_base" placeholder="Nuevo nombre de taller">
        <small style="color: #666;">Debe seleccionar un taller existente o crear uno nuevo</small>
      </div>

      <div class="form-block">
        <label for="imagen">Imagen del Taller:</label>
        <input type="file" name="imagen" id="imagen" accept="image/jpeg,image/png,image/jpg,image/webp">
        <small style="color: #666;">Formatos: JPG, PNG, WEBP (Max 5MB)</small>

        <label for="precio">Precio: <span style="color: red;">*</span></label>
        <input type="number" min="0" step="0.01" name="precio" id="precio" placeholder="0.00" required>
      </div>

      <div class="form-block">
        <label for="fecha_proxima">Fecha Pr√≥xima: <span style="color: red;">*</span></label>
        <input type="date" name="fecha_proxima" id="fecha_proxima" required>

        <label for="hora_inicio">Hora de Inicio: <span style="color: red;">*</span></label>
        <input type="time" name="hora_inicio" id="hora_inicio" required>
      </div>

      <div class="form-block">
        <label for="lugar">Lugar del Evento: <span style="color: red;">*</span></label>
        <input type="text" name="lugar" id="lugar" maxlength="200" required>

        <label for="profesor">Profesor: <span style="color: red;">*</span></label>
        <input type="text" name="profesor" id="profesor" maxlength="100" required>
      </div>

      <div class="form-block">
        <label for="capacidad">Capacidad: <span style="color: red;">*</span></label>
        <input type="number" name="capacidad" id="capacidad" min="1" max="500" required>

        <label for="tipo_taller">Tipo: <span style="color: red;">*</span></label>
        <select name="tipo_taller" id="tipo_taller" required>
          <option value="PRESENCIAL">Presencial</option>
          <option value="ONLINE">Online</option>
        </select>
      </div>

    </div>

    <label for="descripcion_completa" class="label-descripcion">Descripci√≥n completa: <span style="color: red;">*</span></label>
    <textarea name="descripcion_completa" id="descripcion_completa" class="desc-area" 
              minlength="10" maxlength="2000" required 
              placeholder="Describe el taller (m√≠nimo 10 caracteres)"></textarea>
    <small style="color: #666;">M√≠nimo 10 caracteres, m√°ximo 2000</small>

    <div class="btn-right">
      <button type="submit" class="btn-panel" id="btn-guardar">‚ûï Crear Taller</button>
      <button type="button" class="btn-salir" onclick="limpiarFormulario()" style="margin-left: 10px;">üîÑ Limpiar</button>
    </div>
  </form>

  <hr>

  <!-- TABLA DE TALLERES -->
  <table class="tabla-panel">
    <thead>
      <tr>
        <th>Taller Base</th>
        <th>Fecha</th>
        <th>Hora</th>
        <th>Lugar</th>
        <th>Profesor</th>
        <th>Capacidad</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for taller in talleres %}
      <tr>
        <td>{{ taller.taller_base.titulo }}</td>
        <td>{{ taller.fecha_proxima|date:"d/m/Y" }}</td>
        <td>{{ taller.hora_inicio|time:"H:i" }}</td>
        <td>{{ taller.lugar }}</td>
        <td>{{ taller.profesor }}</td>
        <td>{{ taller.capacidad }}</td>
        <td>
          <button
            type="button"
            class="btn-panel"
            onclick="editarTaller(this)"
            data-id="{{ taller.id }}"
            data-base="{{ taller.taller_base.id }}"
            data-descripcion="{{ taller.descripcion_completa|escapejs }}"
            data-precio="{{ taller.precio|stringformat:'f' }}" 
            data-fecha="{{ taller.fecha_proxima|date:'Y-m-d' }}"
            data-hora="{{ taller.hora_inicio|time:'H:i' }}"
            data-lugar="{{ taller.lugar|escapejs }}"
            data-profesor="{{ taller.profesor|escapejs }}"
            data-capacidad="{{ taller.capacidad }}"
            data-tipo="{{ taller.tipo_taller }}">
            ‚úèÔ∏è Editar
          </button>

          <a href="?eliminar={{ taller.id }}" class="btn-salir" 
             onclick="return confirm('‚ö†Ô∏è ¬øEst√°s seguro de eliminar este taller?\n\nEsta acci√≥n no se puede deshacer.');">
            üóëÔ∏è Eliminar
          </a>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="7" class="tabla-vacia">No hay talleres programados.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</section>

<script>
// Establecer fecha m√≠nima como hoy
document.addEventListener('DOMContentLoaded', function() {
  const fechaInput = document.getElementById('fecha_proxima');
  if(fechaInput) {
      const hoy = new Date().toISOString().split('T')[0];
      fechaInput.setAttribute('min', hoy);
  }
  
  // Log para debug
  console.log('Formulario de talleres cargado correctamente');
});

// Validar formulario antes de enviar
const formTaller = document.getElementById('form-taller');
if(formTaller){
    formTaller.addEventListener('submit', function(e) {
      console.log('Formulario enviado - iniciando validaciones');
      
      const tallerBase = document.getElementById('taller_base').value;
      const nuevoTaller = document.getElementById('nuevo_taller_base').value.trim();
      const precio = document.getElementById('precio').value;
      const capacidad = document.getElementById('capacidad').value;
      const descripcion = document.getElementById('descripcion_completa').value.trim();
      
      console.log('Datos del formulario:', {
        tallerBase,
        nuevoTaller,
        precio,
        capacidad,
        descripcion
      });
      
      // Validar que haya seleccionado un taller O creado uno nuevo
      if (!tallerBase && !nuevoTaller) {
        e.preventDefault();
        alert('‚ö†Ô∏è Debes seleccionar un taller existente o crear uno nuevo');
        console.error('Error: No se seleccion√≥ taller base ni se cre√≥ uno nuevo');
        return false;
      }
      
      // Validar precio (debe existir y ser un n√∫mero v√°lido)
      if (!precio || isNaN(parseFloat(precio))) {
        e.preventDefault();
        alert('‚ö†Ô∏è Debes ingresar un precio v√°lido');
        console.error('Error: Precio inv√°lido');
        return false;
      }
      
      if (parseFloat(precio) < 0) {
        e.preventDefault();
        alert('‚ö†Ô∏è El precio no puede ser negativo');
        console.error('Error: Precio negativo');
        return false;
      }
      
      // Validar capacidad
      if (!capacidad || isNaN(parseInt(capacidad))) {
        e.preventDefault();
        alert('‚ö†Ô∏è Debes ingresar una capacidad v√°lida');
        console.error('Error: Capacidad inv√°lida');
        return false;
      }
      
      if (parseInt(capacidad) < 1) {
        e.preventDefault();
        alert('‚ö†Ô∏è La capacidad debe ser al menos 1 persona');
        console.error('Error: Capacidad menor a 1');
        return false;
      }
      
      // Validar descripci√≥n
      if (descripcion.length < 10) {
        e.preventDefault();
        alert('‚ö†Ô∏è La descripci√≥n debe tener al menos 10 caracteres');
        console.error('Error: Descripci√≥n muy corta');
        return false;
      }
      
      console.log('‚úì Todas las validaciones pasaron - enviando formulario');
      return true;
    });
}

function editarTaller(btn) {
  console.log('Editando taller:', btn.dataset.id);
  
  document.getElementById('taller_id').value = btn.dataset.id;
  document.getElementById('taller_base').value = btn.dataset.base;
  document.getElementById('descripcion_completa').value = btn.dataset.descripcion;
  
  // Manejo del formato de precio para input type=number
  let precio = btn.dataset.precio.replace(',', '.');
  document.getElementById('precio').value = precio;
  
  document.getElementById('fecha_proxima').value = btn.dataset.fecha;
  document.getElementById('hora_inicio').value = btn.dataset.hora;
  document.getElementById('lugar').value = btn.dataset.lugar;
  document.getElementById('profesor').value = btn.dataset.profesor;
  document.getElementById('capacidad').value = btn.dataset.capacidad;
  document.getElementById('tipo_taller').value = btn.dataset.tipo;
  
  // Limpiar el campo de nuevo taller
  document.getElementById('nuevo_taller_base').value = '';
  
  document.getElementById('accion').value = 'editar';
  document.getElementById('btn-guardar').innerText = 'üíæ Guardar Cambios';
  
  // Scroll al formulario
  document.getElementById('form-taller').scrollIntoView({ behavior: 'smooth' });
}

function limpiarFormulario() {
  console.log('Limpiando formulario');
  document.getElementById('form-taller').reset();
  document.getElementById('taller_id').value = '';
  document.getElementById('accion').value = 'crear';
  document.getElementById('btn-guardar').innerText = '‚ûï Crear Taller';
}
</script>
{% endblock %}