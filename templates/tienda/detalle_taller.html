{% extends "general.html" %}
{% load static %}

{% block title %}{{ taller.taller_base.titulo }} | TMM Detalle{% endblock %}

{% block content %}
<section class="detail-section">

    <h1 class="detail-title">{{ taller.taller_base.titulo }}</h1>

    <div class="detail-grid">
        
        <!-- Columna Imagen -->
        <div class="detail-image">
            {% if taller.imagen %}
                <img src="{{ taller.imagen.url }}" alt="Imagen de {{ taller.taller_base.titulo }}">
            {% else %}
                <img src="{% static 'img/placeholder_taller.jpg' %}" alt="Taller sin imagen"> 
            {% endif %}
            
            <div class="mt-3 p-2 text-center" style="background-color: var(--color-secundario-verde); border-radius: 8px; margin-top: 1rem;">
                <p class="mb-0" style="color: var(--color-texto-gris); margin: 0;">
                    Impartido por: <strong style="color: var(--color-principal-rosa);">{{ taller.profesor }}</strong>
                </p>
            </div>
        </div>

        <!-- Columna Informaci칩n -->
        <div class="detail-info">
            
            <h2>Detalles Clave del Evento</h2>
            
            <ul class="info-list">
                <li><strong>Precio:</strong> ${{ taller.precio|floatformat:0 }} CLP</li>
                <li><strong>Fecha:</strong> {{ taller.fecha_proxima|date:"d M Y" }}</li>
                <li><strong>Hora:</strong> {{ taller.hora_inicio }} hrs.</li>
                <li><strong>Lugar:</strong> {{ taller.lugar }} ({{ taller.get_tipo_taller_display }})</li>
                <li><strong>Cupos Disponibles:</strong> {{ taller.capacidad }}</li>
            </ul>
            
            {% if taller.capacidad > 0 %}
                <!-- Formulario de Compra -->
                <!-- La acci칩n apunta a 'add_to_cart_taller' que procesa la lista de nombres -->
                <form action="{% url 'add_to_cart_taller' taller_id=taller.id %}" method="post" class="mt-4" style="margin-top: 1.5rem;">
                    {% csrf_token %}

                    <!-- Secci칩n Regalo -->
                    <div style="margin-bottom: 15px; padding: 15px; background-color: #f9f9f9; border-radius: 8px; border: 1px solid #eee;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <input type="checkbox" id="checkRegalo" name="es_regalo" style="width: 18px; height: 18px; cursor: pointer;">
                            <label for="checkRegalo" style="cursor: pointer; color: var(--color-texto-gris); font-weight: bold; margin: 0;">
                                游꾸 쮼s para regalo?
                            </label>
                        </div>

                        <!-- Contenedor de Beneficiarios -->
                        <div id="contenedorBeneficiarios" style="display: none;">
                            <p style="font-size: 0.85em; color: #666; margin-bottom: 10px;">
                                Ingresa los datos de las personas a quienes regalar치s el taller.<br>
                                <small>Puedes agregar m칰ltiples beneficiarios.</small>
                            </p>
                            
                            <div id="listaBeneficiarios">
                                <!-- Primer beneficiario (Fijo) -->
                                <div class="beneficiario-item" style="background: white; padding: 10px; border-radius: 5px; border: 1px solid #ddd; margin-bottom: 10px;">
                                    <div style="margin-bottom: 8px;">
                                        <label style="display: block; font-size: 0.8em; font-weight: bold; margin-bottom: 2px;">Nombre:</label>
                                        <!-- Importante: name="nombre_beneficiario" se usar치 con getlist en Python -->
                                        <input type="text" name="nombre_beneficiario" placeholder="Ej: Mar칤a P칠rez" style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.8em; font-weight: bold; margin-bottom: 2px;">Correo:</label>
                                        <!-- Importante: name="email_beneficiario" se usar치 con getlist en Python -->
                                        <input type="email" name="email_beneficiario" placeholder="Ej: maria@email.com" style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
                                    </div>
                                </div>
                            </div>

                            <!-- Bot칩n para agregar m치s -->
                            <button type="button" id="btnAgregarBeneficiario" style="background: transparent; border: 1px dashed #999; color: #555; width: 100%; padding: 8px; border-radius: 5px; cursor: pointer; font-size: 0.9em; transition: background 0.2s;">
                                <i class="fas fa-plus"></i> Agregar otro beneficiario
                            </button>
                        </div>
                    </div>

                    <button type="submit" class="cta-button-detail">
                        Inscr칤bete Ahora
                    </button>
                </form>
                
                <p class="mt-3 text-muted" style="font-size: 0.9em; color: var(--color-texto-gris); margin-top: 1rem;">
                    * Se requiere iniciar sesi칩n para a침adir al carrito.
                </p>
            {% else %}
                <div style="background-color: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin-top: 20px; text-align: center;">
                    <strong>춰Lo sentimos!</strong> No quedan cupos disponibles para esta fecha.
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Descripci칩n Larga -->
    <div class="detail-header">
        <div class="descripcion_talleres_detalle">
            <h2>Descripci칩n del Taller</h2>
            <p class="descripcion-talleres">{{ taller.descripcion_completa|linebreaksbr }}</p>
        </div>
    </div>

    <!-- Galer칤a -->
    {% if taller.galeria.all %}
    <section class="taller-galeria">
        <h2>Galer칤a del Taller</h2>
        <div class="galeria-grid">
            {% for img in taller.galeria.all %}
            <div class="galeria-item">
                <img src="{{ img.imagen.url }}" alt="{{ img.descripcion|default:'Imagen de galer칤a' }}">
                {% if img.descripcion %}
                <p>{{ img.descripcion }}</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

</section>

<!-- Script para la l칩gica din치mica del regalo -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const checkRegalo = document.getElementById('checkRegalo');
        const contenedorBeneficiarios = document.getElementById('contenedorBeneficiarios');
        const listaBeneficiarios = document.getElementById('listaBeneficiarios');
        const btnAgregar = document.getElementById('btnAgregarBeneficiario');

        // 1. Mostrar/Ocultar secci칩n de regalos
        if(checkRegalo) {
            checkRegalo.addEventListener('change', function() {
                if (this.checked) {
                    contenedorBeneficiarios.style.display = 'block';
                    toggleRequired(true);
                } else {
                    contenedorBeneficiarios.style.display = 'none';
                    toggleRequired(false);
                }
            });
        }

        // 2. Agregar nuevo bloque de beneficiario
        if(btnAgregar) {
            btnAgregar.addEventListener('click', function() {
                const nuevoItem = document.createElement('div');
                nuevoItem.className = 'beneficiario-item';
                nuevoItem.style = "background: white; padding: 10px; border-radius: 5px; border: 1px solid #ddd; margin-bottom: 10px; position: relative;";
                
                // Usamos los mismos nombres 'nombre_beneficiario' y 'email_beneficiario'
                // para que Django los reciba como una lista (getlist)
                nuevoItem.innerHTML = `
                    <button type="button" class="btn-eliminar-item" style="position: absolute; top: 5px; right: 5px; background: none; border: none; color: #dc3545; cursor: pointer; font-size: 1.2em; font-weight: bold;">&times;</button>
                    <div style="margin-bottom: 8px;">
                        <label style="display: block; font-size: 0.8em; font-weight: bold; margin-bottom: 2px;">Nombre:</label>
                        <input type="text" name="nombre_beneficiario" placeholder="Ej: Otro Nombre" required style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 0.8em; font-weight: bold; margin-bottom: 2px;">Correo:</label>
                        <input type="email" name="email_beneficiario" placeholder="Ej: otro@email.com" required style="width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                `;
                
                listaBeneficiarios.appendChild(nuevoItem);
                
                // Evento para eliminar este item espec칤fico si el usuario se arrepiente
                nuevoItem.querySelector('.btn-eliminar-item').addEventListener('click', function() {
                    nuevoItem.remove();
                });
            });
        }

        // Funci칩n auxiliar para activar/desactivar 'required'
        function toggleRequired(isRequired) {
            const inputs = listaBeneficiarios.querySelectorAll('input');
            inputs.forEach(input => {
                input.required = isRequired;
                // Si ocultamos la secci칩n, limpiamos los valores para no enviar datos basura
                if(!isRequired) input.value = ''; 
            });
        }
    });
</script>

{% endblock content %}