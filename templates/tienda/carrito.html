{% extends 'general.html' %}
{% load static %}
{% block content %}
<main class="tienda-main-content carrito-page">
    <h2 class="carrito-title">TU CARRITO DE COMPRAS</h2>

    <section class="carrito-layout">
        
        <!-- AREA DE PRODUCTOS -->
        <div class="carrito-items-area">
            {% for item in carrito.items.all %}
            <div class="cart-item-card">
                {% if item.producto %}
                    <img src="{% if item.producto.imagen %}{{ item.producto.imagen.url }}{% else %}{% static 'tienda/default_prod.png' %}{% endif %}" 
                         alt="{{ item.producto.nombre }}" class="cart-product-img">
                    
                    <div class="cart-product-info">
                        <span class="cart-product-name">{{ item.producto.nombre }}</span>
                        <span class="cart-product-price">Precio: ${{ item.producto.precio }}</span>
                        
                        <div class="quantity-control">
                            <a href="{% url 'update_cart' item.id 'remove' %}" class="btn-qty" title="Reducir cantidad">−</a>
                            <span>{{ item.cantidad }}</span>
                            <a href="{% url 'update_cart' item.id 'add' %}" class="btn-qty" title="Aumentar cantidad">+</a>
                        </div>
                        
                        <span class="cart-product-total">Total: ${{ item.get_total }}</span>
                    </div>
                {% elif item.taller_evento %}
                    <img src="{% if item.taller_evento.taller_base.imagen %}{{ item.taller_evento.taller_base.imagen.url }}{% else %}{% static 'img/placeholder-taller.jpg' %}{% endif %}" 
                         alt="{{ item.taller_evento.taller_base.titulo }}" class="cart-product-img">
                    
                    <div class="cart-product-info">
                        <span class="cart-product-name">{{ item.taller_evento.taller_base.titulo }}</span>
                        <span class="cart-product-price">Precio: ${{ item.taller_evento.precio }}</span>
                        <span class="cart-product-date">Fecha: {{ item.taller_evento.fecha_proxima }}</span>
                        
                        <div class="quantity-control">
                            <span>Cantidad: {{ item.cantidad }}</span>
                            <a href="{%url 'update_cart' item.id 'delete' %}" id= btn-eliminar class="btn-eliminar">Eliminar</a>
                        </div>
                        
                        
                        <span class="cart-product-total">Total: ${{ item.get_total }}</span>
                    </div>
                {% endif %}
            </div>
            {% empty %}
            <p>Tu carrito está vacío.</p>
            {% endfor %}
        </div>

        <!-- AREA DE RESUMEN Y PAGO -->
        <div class="carrito-summary-area">
            
            <!-- TARJETA DE DIRECCIÓN CORREGIDA -->
            {% if not solo_talleres %}

            <div class="address-box">

                <!-- Si NO se está editando la dirección -->
                {% if not request.GET.editar %}
                    {% if direccion.calle %}
                        <div class="direccion-texto">
                            <p><strong>Dirección de entrega</strong></p>
                            <p>{{ direccion.calle }}, {{ direccion.numero }}</p>
                            <p>{{ direccion.ciudad }} {{ direccion.zip }}</p>
                        </div>
                    {% else %}
                        <p>No has ingresado una dirección de entrega.</p>
                    {% endif %}

                    <a href="?editar=1" class="btn-modificar">Modificar</a>

                {% else %}
                <!-- FORMULARIO cuando se hace clic en “Modificar” -->
                <form method="post" action="{% url 'guardar_direccion' %}">
                    {% csrf_token %}

                    <label>Calle:</label>
                    <input type="text" name="calle" value="{{ direccion.calle }}">

                    <label>Número / Depto:</label>
                    <input type="text" name="numero" value="{{ direccion.numero }}">

                    <label>Ciudad:</label>
                    <input type="text" name="ciudad" value="{{ direccion.ciudad }}">

                    <label>Código Postal:</label>
                    <input type="text" name="zip" value="{{ direccion.zip }}">

                    <button type="submit" class="btn-pagar">Guardar</button>
                    <a href="{% url 'carrito' %}" class="btn-modificar">Cancelar</a>
                </form>
                {% endif %}

            </div>

            {% endif %}


            
        <div class="discount-box">

            <form method="post" action="{% url 'carrito' %}">
                {% csrf_token %}

                <!-- INPUT DEL CUPÓN -->
                <input type="text"
                    name="codigo"
                    placeholder="Ingresa código de descuento"
                    value="{% if cupon %}{{ cupon.codigo }}{% endif %}">

                <!-- BOTÓN APLICAR -->
                <button type="submit" name="accion" value="aplicar" class="btn-aplicar">
                    Aplicar
                </button>

                <!-- SI HAY CUPÓN, MUESTRA BOTÓN QUITAR -->
                {% if cupon %}
                <div class="cupon-info">
                    <small>
                        Cupón aplicado: <strong>{{ cupon.codigo }}</strong> — {{ cupon.porcentaje_descuento }}%
                    </small>

                    <button type="submit" name="accion" value="quitar" class="btn-eliminar-cupon">
                        Quitar
                    </button>
                </div>
                {% endif %}

            </form>

        </div>



            <div class="total-container">
                
                <div class="total-row">
                    <span>Subtotal:</span>
                    <span class="subtotal-amount">${{ subtotal }}</span>
                </div>
                
                <div class="total-row">
                    <span>Descuento:</span>
                    <span class="discount-amount discount">-${{ descuento }}</span>
                </div>
                
                <div class="total-row final">
                    <span>Total a pagar:</span>
                    <span class="total-amount amount">${{ total_final }}</span>
                </div>
            </div>
            
            <div class="payment-box">
                {% if carrito.items.all %}
                <form id="checkout-form" method="post" action="{% url 'mp_crear_preferencia' %}">
                    {% csrf_token %}
                    <button type="submit" class="btn-pagar">IR A PAGAR</button>
                    <button class="btn-pagar" id="btn-simular-compra">Simular Compra</button>
                </form>

                {% else %}
                    <p>Tu carrito está vacío.</p>
                {% endif %}
            </div>
            
        </div>
    </section>
</main>
<script>

//===SCRIPT PARA SIMULAR COMPRA===
document.getElementById("btn-simular-compra")?.addEventListener("click", function() {
    fetch("{% url 'simular_compra' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
        },
    })
    .then(res => res.json())
    .then(data => {
        alert(data.message);
        if (data.redirect) {
            window.location.href = data.redirect;
        }
    })
    .catch(err => alert("Error al simular la compra."));
});

//===SCRIPT PARA MERCADO PAGO CHECKOUT===
/*
document.getElementById("checkout-form")?.addEventListener("submit", async function(e) {
    e.preventDefault();

    try {
        const response = await fetch("{% url 'mp_crear_preferencia' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}"
            }
        });

        const data = await response.json();

        if (data.init_point) {
            // Redirige automáticamente al checkout de Mercado Pago
            window.location.href = data.init_point;
        } else {
            alert("No se pudo generar la preferencia de pago.");
        }
    } catch (error) {
        console.error("❌ Error en la solicitud:", error);
        alert("Error al comunicarse con el servidor.");
    }
});
*/


</script>

{% endblock content %}