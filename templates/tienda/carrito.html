{% extends 'general.html' %}
{% load static %}

{% block content %}
<main class="tienda-main-content carrito-page">
    <h2 class="carrito-title">TU CARRITO DE COMPRAS</h2>

    <section class="carrito-layout">
        
        <!-- AREA DE PRODUCTOS -->
        <div class="carrito-items-area">
            {% for item in carrito.items.all %}
            <div class="cart-item-card">
                
                <!-- CASO 1: PRODUCTO F√çSICO -->
                {% if item.producto %}
                    <img src="{% if item.producto.imagen %}{{ item.producto.imagen.url }}{% else %}{% static 'tienda/default_prod.png' %}{% endif %}" 
                         alt="{{ item.producto.nombre }}" class="cart-product-img">
                    
                    <div class="cart-product-info">
                        <span class="cart-product-name">{{ item.producto.nombre }}</span>
                        <span class="cart-product-price">Precio: ${{ item.producto.precio }}</span>
                        
                        <div class="quantity-control">
                            <a href="{% url 'update_cart' item.id 'remove' %}" class="btn-qty" title="Reducir cantidad">‚àí</a>
                            <span>{{ item.cantidad }}</span>
                            <a href="{% url 'update_cart' item.id 'add' %}" class="btn-qty" title="Aumentar cantidad">+</a>
                        </div>
                        
                        <span class="cart-product-total">Total: ${{ item.get_total }}</span>
                    </div>

                <!-- CASO 2: TALLER / EVENTO -->
                {% elif item.taller_evento %}
                    <img src="{% if item.taller_evento.taller_base.imagen %}{{ item.taller_evento.taller_base.imagen.url }}{% else %}{% static 'img/placeholder-taller.jpg' %}{% endif %}" 
                         alt="{{ item.taller_evento.taller_base.titulo }}" class="cart-product-img">
                    
                    <div class="cart-product-info">
                        <span class="cart-product-name">{{ item.taller_evento.taller_base.titulo }}</span>
                        <span class="cart-product-price">Precio: ${{ item.taller_evento.precio }}</span>
                        <span class="cart-product-date">Fecha: {{ item.taller_evento.fecha_proxima }}</span>
                        
                        <!-- ========================================== -->
                        <!-- NUEVO: VISUALIZACI√ìN DE DATOS DE REGALO -->
                        <!-- ========================================== -->
                        {% if item.es_regalo %}
                            <div style="margin: 8px 0; padding: 8px; background-color: #fff0f6; border-radius: 6px; border: 1px solid #fcc2d7; font-size: 0.9em;">
                                <span style="font-weight: bold; color: #d63384;">üéÅ ES UN REGALO</span><br>
                                <span style="color: #555;">Para: <strong>{{ item.nombre_beneficiario }}</strong></span><br>
                                <span style="color: #777; font-size: 0.85em;">Invitaci√≥n a: {{ item.email_beneficiario }}</span>
                            </div>
                        {% endif %}
                        <!-- ========================================== -->

                        <div class="quantity-control">
                            <span>Cantidad: {{ item.cantidad }}</span>
                            <!-- Bot√≥n Eliminar corregido para talleres -->
                            <a href="{% url 'update_cart' item.id 'delete' %}" class="btn-eliminar" style="margin-left: 10px; color: #dc3545; text-decoration: none; font-size: 0.9em;">
                                <i class="fas fa-trash"></i> Eliminar
                            </a>
                        </div>
                        
                        <span class="cart-product-total">Total: ${{ item.get_total }}</span>
                    </div>
                {% endif %}
            </div>
            {% empty %}
            <p>Tu carrito est√° vac√≠o.</p>
            {% endfor %}
        </div>

        <!-- AREA DE RESUMEN Y PAGO -->
        <div class="carrito-summary-area">
            
            <!-- TARJETA DE DIRECCI√ìN -->
            {% if not solo_talleres %}
            <div class="address-box">
                <!-- Si NO se est√° editando la direcci√≥n -->
                {% if not request.GET.editar %}
                    {% if direccion.calle %}
                        <div class="direccion-texto">
                            <p><strong>Direcci√≥n de entrega</strong></p>
                            <p>{{ direccion.calle }}, {{ direccion.numero }}</p>
                            <p>{{ direccion.ciudad }} {{ direccion.zip }}</p>
                        </div>
                    {% else %}
                        <p>No has ingresado una direcci√≥n de entrega.</p>
                    {% endif %}

                    <a href="?editar=1" class="btn-modificar">Modificar</a>

                {% else %}
                <!-- FORMULARIO EDITAR DIRECCI√ìN -->
                <form method="post" action="{% url 'guardar_direccion' %}">
                    {% csrf_token %}
                    <label>Calle:</label>
                    <input type="text" name="calle" value="{{ direccion.calle }}">

                    <label>N√∫mero / Depto:</label>
                    <input type="text" name="numero" value="{{ direccion.numero }}">

                    <label>Ciudad:</label>
                    <input type="text" name="ciudad" value="{{ direccion.ciudad }}">

                    <label>C√≥digo Postal:</label>
                    <input type="text" name="zip" value="{{ direccion.zip }}">

                    <button type="submit" class="btn-pagar">Guardar</button>
                    <a href="{% url 'carrito' %}" class="btn-modificar">Cancelar</a>
                </form>
                {% endif %}
            </div>
            {% endif %}

            <!-- TARJETA DE CUPONES -->
            <div class="discount-box">
                <form method="post" action="{% url 'carrito' %}">
                    {% csrf_token %}
                    <input type="text" name="codigo" placeholder="Ingresa c√≥digo de descuento" value="{% if cupon %}{{ cupon.codigo }}{% endif %}">
                    <button type="submit" name="accion" value="aplicar" class="btn-aplicar">Aplicar</button>

                    {% if cupon %}
                    <div class="cupon-info">
                        <small>Cup√≥n aplicado: <strong>{{ cupon.codigo }}</strong> ‚Äî {{ cupon.porcentaje_descuento }}%</small>
                        <button type="submit" name="accion" value="quitar" class="btn-eliminar-cupon">Quitar</button>
                    </div>
                    {% endif %}
                </form>
            </div>

            <!-- TOTALES -->
            <div class="total-container">
                <div class="total-row">
                    <span>Subtotal:</span>
                    <span class="subtotal-amount">${{ subtotal }}</span>
                </div>
                <div class="total-row">
                    <span>Descuento:</span>
                    <span class="discount-amount discount">-${{ descuento }}</span>
                </div>
                <div class="total-row final">
                    <span>Total a pagar:</span>
                    <span class="total-amount amount">${{ total_final }}</span>
                </div>
            </div>
            
            <!-- BOTONES DE PAGO -->
            <div class="payment-box">
                {% if carrito.items.all %}
                <!-- Formulario real para Mercado Pago -->
                <!-- Nota: Aseg√∫rate de que la URL 'mp_crear_preferencia' est√© en urls.py apuntando a crear_preferencia -->
                <form id="checkout-form" method="post"> <!-- JS maneja el submit si usas fetch, o action directo -->
                    {% csrf_token %}
                    <!-- Bot√≥n para flujo real (comentado si solo usas simulaci√≥n por ahora) -->
                    <!-- <button type="button" id="btn-pagar-mp" class="btn-pagar">IR A PAGAR (MP)</button> -->
                    
                    <button type="button" class="btn-pagar" id="btn-simular-compra" style="background-color: #28a745;">Simular Compra (Test)</button>
                </form>
                {% else %}
                    <p>Tu carrito est√° vac√≠o.</p>
                {% endif %}
            </div>
            
        </div>
    </section>
</main>

<script>
//===SCRIPT PARA SIMULAR COMPRA===
const btnSimular = document.getElementById("btn-simular-compra");
if (btnSimular) {
    btnSimular.addEventListener("click", function() {
        if(!confirm("¬øConfirmar simulaci√≥n de compra? Se enviar√°n los correos de invitaci√≥n.")) return;

        fetch("{% url 'simular_compra' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
            },
        })
        .then(res => res.json())
        .then(data => {
            alert(data.message);
            if (data.redirect) {
                window.location.href = data.redirect;
            }
        })
        .catch(err => {
            console.error(err);
            alert("Error al simular la compra.");
        });
    });
}

//===SCRIPT OPCIONAL PARA MERCADO PAGO (Si decides activarlo)===
/*
const btnMP = document.getElementById("btn-pagar-mp");
if(btnMP){
    btnMP.addEventListener("click", async function() {
        try {
            const response = await fetch("{% url 'mp_crear_preferencia' %}", { // Aseg√∫rate que esta URL exista en urls.py
                method: "POST",
                headers: { "X-CSRFToken": "{{ csrf_token }}" }
            });
            const data = await response.json();
            if (data.init_point) {
                window.location.href = data.init_point;
            } else {
                alert("Error al iniciar pago: " + (data.error || "Desconocido"));
            }
        } catch (error) {
            console.error("Error:", error);
            alert("Error de conexi√≥n con el servidor.");
        }
    });
}
*/
</script>
{% endblock content %}